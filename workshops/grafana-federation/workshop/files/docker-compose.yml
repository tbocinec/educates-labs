services:
  # Grafana 1 - InfluxDB Source
  grafana-influx:
    image: grafana/grafana:latest
    container_name: grafana-influx
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=http://localhost:3001
    volumes:
      - grafana1-storage:/var/lib/grafana
    networks:
      - federation

  # Grafana 2 - ClickHouse Source  
  grafana-clickhouse:
    image: grafana/grafana:latest
    container_name: grafana-clickhouse
    ports:
      - "3002:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=http://localhost:3002
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    volumes:
      - grafana2-storage:/var/lib/grafana
    networks:
      - federation

  # Grafana 3 - Federation (reads from Grafana1 + Grafana2)
  grafana-federation:
    image: grafana/grafana:latest
    container_name: grafana-federation
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=http://localhost:3000
    volumes:
      - grafana3-storage:/var/lib/grafana
    networks:
      - federation
    depends_on:
      - grafana-influx
      - grafana-clickhouse

  # InfluxDB Data Source
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpass
      - DOCKER_INFLUXDB_INIT_ORG=workshop
      - DOCKER_INFLUXDB_INIT_BUCKET=sensors
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=workshop-token-123456789
    volumes:
      - influxdb-storage:/var/lib/influxdb2
    networks:
      - federation

  # ClickHouse Data Source
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - CLICKHOUSE_DB=workshop
      - CLICKHOUSE_USER=admin
      - CLICKHOUSE_PASSWORD=admin
    volumes:
      - clickhouse-storage:/var/lib/clickhouse
      - ./data/clickhouse-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - federation

volumes:
  grafana1-storage:
  grafana2-storage:
  grafana3-storage:
  influxdb-storage:
  clickhouse-storage:

networks:
  federation:
    driver: bridge